import streamlit as st
import requests
import json
import pandas as pd
from datetime import datetime, timedelta
import time
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import numpy as np
import urllib3

# âš ï¸ ìš´ì˜ ì „ ì£¼ì˜: ì¸ì¦í‚¤/ê³„ì¢Œë²ˆí˜¸ëŠ” .env ë“± ì•ˆì „í•œ ë°©ë²•ìœ¼ë¡œ ì£¼ì…í•˜ì„¸ìš”.

# SSL ê²½ê³  ë©”ì‹œì§€ ë¹„í™œì„±í™” (ê°œë°œìš©)
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

############################################
#                Core Bot                  #
############################################
class KISStockBot:
    """í•œêµ­íˆ¬ìì¦ê¶Œ OpenAPIë¥¼ ì´ìš©í•œ ì½”ìŠ¤í”¼200 ì¢…ëª© ë¶„ì„ ë´‡ (ê°œì„ íŒ)

    ë³€ê²½ ì‚¬í•­ ìš”ì•½ (v7):
    - ì§€í‘œ í™•ì¥: 5D ëª¨ë©˜í…€, 20D ê±°ë˜ëŸ‰ Z-Score, 10D ë³€ë™ì„±(í‘œì¤€í¸ì°¨), 20D í‰ê·  ê±°ë˜ëŒ€ê¸ˆ ë“±
    - ìŠ¤ì½”ì–´ë§ ê°œí¸: ëª¨ë©˜í…€/ìœ ë™ì„± ê°€ì¤‘, ë³€ë™ì„± í˜ë„í‹°, MA íŠ¸ë Œë“œ/RSI/ê±°ë˜ëŸ‰ ì‹ í˜¸ í†µí•©
    - ìœ ë™ì„± í•„í„°: 20D í‰ê·  ê±°ë˜ëŒ€ê¸ˆ í•˜í•œ(ì‚¬ìš©ì ì„¤ì •)
    """

    def __init__(self, app_key, app_secret, acc_no, acc_prod_cd="01"):
        self.base_url = "https://openapi.koreainvestment.com:9443"
        self.app_key = app_key
        self.app_secret = app_secret
        self.acc_no = acc_no
        self.acc_prod_cd = acc_prod_cd
        self.access_token = None

    def get_access_token(self):
        """ì ‘ê·¼ í† í° ë°œê¸‰"""
        url = f"{self.base_url}/oauth2/tokenP"
        headers = {"content-type": "application/json"}
        data = {
            "grant_type": "client_credentials",
            "appkey": self.app_key,
            "appsecret": self.app_secret,
        }
        res = requests.post(url, headers=headers, data=json.dumps(data), verify=False)
        if res.status_code == 200:
            self.access_token = res.json().get("access_token")
            return self.access_token
        else:
            raise RuntimeError(f"í† í° ë°œê¸‰ ì‹¤íŒ¨: {res.status_code} | {res.text}")

    def get_kospi200_list(self):
        """ì½”ìŠ¤í”¼200 ì¢…ëª© ë¦¬ìŠ¤íŠ¸ (ìƒ˜í”Œ: ì¼ë¶€ ë°œì·Œ)
        â€» ìš´ì˜ ì‹œì—ëŠ” KRX/ë¸Œë¡œì»¤ APIë¡œ ì‹¤ì‹œê°„ ë™ê¸°í™” ê¶Œì¥
        """
        return {
            "005930": "ì‚¼ì„±ì „ì",
            "000660": "SKí•˜ì´ë‹‰ìŠ¤",
            "035420": "NAVER",
            "005380": "í˜„ëŒ€ì°¨",
            "051910": "LGí™”í•™",
            "006400": "ì‚¼ì„±SDI",
            "035720": "ì¹´ì¹´ì˜¤",
            "028260": "ì‚¼ì„±ë¬¼ì‚°",
            "012330": "í˜„ëŒ€ëª¨ë¹„ìŠ¤",
            "068270": "ì…€íŠ¸ë¦¬ì˜¨",
            "207940": "ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤",
            "105560": "KBê¸ˆìœµ",
            "055550": "ì‹ í•œì§€ì£¼",
            "003670": "í¬ìŠ¤ì½”í“¨ì²˜ì— ",
            "086790": "í•˜ë‚˜ê¸ˆìœµì§€ì£¼",
        }

    def get_stock_daily_price(self, stock_code):
        """ì¢…ëª© ì¼ë³„ ì‹œì„¸ ì¡°íšŒ (ìµœê·¼ ~ìˆ˜ì‹­ì˜ì—…ì¼)
        API íŠ¹ì„±ìƒ ìµœì‹ ì´ 0ë²ˆì§¸ ì¸ë±ìŠ¤ë¡œ ì˜¤ëŠ” í˜•íƒœë¥¼ ê°€ì •í•©ë‹ˆë‹¤.
        """
        url = f"{self.base_url}/uapi/domestic-stock/v1/quotations/inquire-daily-price"
        headers = {
            "content-type": "application/json",
            "authorization": f"Bearer {self.access_token}",
            "appkey": self.app_key,
            "appsecret": self.app_secret,
            "tr_id": "FHKST01010400",
        }
        params = {
            "FID_COND_MRKT_DIV_CODE": "J",
            "FID_INPUT_ISCD": stock_code,
            "FID_PERIOD_DIV_CODE": "D",
            "FID_ORG_ADJ_PRC": "0",
        }
        res = requests.get(url, headers=headers, params=params, verify=False)
        if res.status_code == 200:
            return res.json().get("output")
        raise RuntimeError(f"ì‹œì„¸ ì¡°íšŒ ì‹¤íŒ¨: {stock_code} | {res.status_code} | {res.text}")

    @staticmethod
    def _to_num(series):
        return pd.to_numeric(series, errors="coerce")

    def _prep_df(self, price_data: list) -> pd.DataFrame:
        df = pd.DataFrame(price_data).copy()
        # ìˆ˜ì¹˜í˜• ë³€í™˜
        for col in [
            "stck_oprc",
            "stck_hgpr",
            "stck_lwpr",
            "stck_clpr",
            "acml_vol",
        ]:
            df[col] = self._to_num(df[col])
        # ìµœì‹ í–‰ì´ 0ë²ˆì§¸ë¼ê³  ê°€ì • â†’ ë¶„ì„/í”Œë¡œíŒ… í¸ì˜ë¥¼ ìœ„í•´ ìµœì‹ ì´ ì•„ë˜ë¡œ ì˜¤ë„ë¡ ë’¤ì§‘ìŒ
        df = df.iloc[::-1].reset_index(drop=True)

        # ë‚ ì§œë¥¼ datetimeìœ¼ë¡œ ì •ê·œí™”
        if "stck_bsop_date" in df.columns:
            df["stck_bsop_date"] = pd.to_datetime(df["stck_bsop_date"], format="%Y%m%d", errors="coerce")

        # ê¸°ë³¸ ì§€í‘œ
        df["ret1"] = df["stck_clpr"].pct_change()
        df["ret5"] = df["stck_clpr"].pct_change(5)
        df["ma5"] = df["stck_clpr"].rolling(5).mean()
        df["ma20"] = df["stck_clpr"].rolling(20).mean()
        df["vol_ma5"] = df["acml_vol"].rolling(5).mean()
        df["vol_ma20"] = df["acml_vol"].rolling(20).mean()
        df["vol_z20"] = (df["acml_vol"] - df["vol_ma20"]) / df["acml_vol"].rolling(20).std()
        df["volatility10"] = df["ret1"].rolling(10).std()  # ì¼ë³„ ìˆ˜ìµë¥  10D í‘œì¤€í¸ì°¨

        # ê±°ë˜ëŒ€ê¸ˆ(ì›) ê·¼ì‚¬ì¹˜: ì¢…ê°€ * ê±°ë˜ëŸ‰
        df["trd_val"] = df["stck_clpr"] * df["acml_vol"]
        df["trd_val_ma20"] = df["trd_val"].rolling(20).mean()

        # RSI(14)
        delta = df["stck_clpr"].diff()
        gain = (delta.where(delta > 0, 0)).rolling(14).mean()
        loss = (-delta.where(delta < 0, 0)).rolling(14).mean()
        rs = gain / loss
        df["rsi14"] = 100 - (100 / (1 + rs))

        return df

    def analyze_stock(self, stock_code: str, stock_name: str, min_trd_val: float):
        """ê°œë³„ ì¢…ëª© ë¶„ì„ ë° ìŠ¤ì½”ì–´ ì‚°ì¶œ"""
        raw = self.get_stock_daily_price(stock_code)
        df = self._prep_df(raw)
        if len(df) < 25:
            raise ValueError("ì´ë™í‰ê· /ë³€ë™ì„± ê³„ì‚°ì„ ìœ„í•œ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤")

        latest = df.iloc[-1]
        prev = df.iloc[-2]

        # ---- ìœ ë™ì„± í•„í„° ----
        avg_trd_val20 = float(latest["trd_val_ma20"]) if pd.notna(latest["trd_val_ma20"]) else 0.0
        liquidity_pass = bool(avg_trd_val20 >= min_trd_val)

        # ---- ìŠ¤ì½”ì–´ë§ ----
        score = 0.0
        signals = []

        # 1) íŠ¸ë Œë“œ: MA5 > MA20 (ê°€ì¤‘ì¹˜ +4)
        if latest["ma5"] > latest["ma20"]:
            score += 4
            signals.append("MA ê³¨ë“ í¬ë¡œìŠ¤(5>20)")

        # 2) ëª¨ë©˜í…€(5D): êµ¬ê°„ ìˆ˜ìµë¥ 
        mom5 = latest["ret5"] if pd.notna(latest["ret5"]) else 0.0
        if mom5 > 0.05:
            score += 3
            signals.append(f"5D ëª¨ë©˜í…€ ê°•í•¨(+{mom5*100:.1f}%)")
        elif mom5 > 0.02:
            score += 2
            signals.append(f"5D ëª¨ë©˜í…€ ì–‘í˜¸(+{mom5*100:.1f}%)")
        elif mom5 < -0.03:
            score -= 1
            signals.append(f"5D ì¡°ì •(-{abs(mom5)*100:.1f}%)")

        # 3) ê±°ë˜ëŸ‰ Z-Score(20D) â€” ìœ ë™ì„±/ê´€ì‹¬ë„ ê°€ì¤‘ (+2/+1)
        volz = latest["vol_z20"] if pd.notna(latest["vol_z20"]) else 0.0
        if volz >= 1.5:
            score += 2
            signals.append("ê±°ë˜ëŸ‰ ê¸‰ì¦(Zâ‰¥1.5)")
        elif volz >= 0.5:
            score += 1
            signals.append("ê±°ë˜ëŸ‰ ì¦ê°€(Zâ‰¥0.5)")

        # 4) RSI(14) â€” ê³¼ì—´ íšŒí”¼, 45~65 êµ¬ê°„ ì„ í˜¸
        rsi = latest["rsi14"] if pd.notna(latest["rsi14"]) else np.nan
        if pd.notna(rsi):
            if 45 <= rsi <= 65:
                score += 1.5
                signals.append(f"RSI ì¤‘ë¦½ìš°ìƒ({rsi:.1f})")
            elif rsi < 30:
                score += 0.5  # ê³¼ë§¤ë„ ë°˜ë“± ì—¬ì§€
                signals.append(f"RSI ê³¼ë§¤ë„({rsi:.1f})")
            elif rsi > 75:
                score -= 0.5
                signals.append(f"RSI ê³¼ì—´({rsi:.1f})")

        # 5) ë‹¨ê¸° ë³€ë™ì„± í˜ë„í‹° (10D Ïƒ) â€” ê³¼ë„í•œ ë³€ë™ íšŒí”¼
        vol10 = latest["volatility10"] if pd.notna(latest["volatility10"]) else 0.0
        if vol10 >= 0.035:  # 3.5% ì´ìƒ
            score -= 1.0
            signals.append("ë³€ë™ì„± ë†’ìŒ(10D Ïƒâ‰¥3.5%)")
        elif vol10 >= 0.025:
            score -= 0.5
            signals.append("ë³€ë™ì„± ë‹¤ì†Œ ë†’ìŒ")

        # 6) ì „ì¼ ëŒ€ë¹„ ë“±ë½ ë³´ë„ˆìŠ¤(+1)
        day_chg = (latest["stck_clpr"] - prev["stck_clpr"]) / prev["stck_clpr"]
        if day_chg > 0:
            score += 1
            signals.append(f"ì „ì¼ ëŒ€ë¹„ +{day_chg*100:.2f}%")

        result = {
            "code": stock_code,
            "name": stock_name,
            "price": int(latest["stck_clpr"]),
            "ma5": float(latest["ma5"]) if pd.notna(latest["ma5"]) else None,
            "ma20": float(latest["ma20"]) if pd.notna(latest["ma20"]) else None,
            "rsi": float(rsi) if pd.notna(rsi) else None,
            "volume": int(latest["acml_vol"]) if pd.notna(latest["acml_vol"]) else None,
            "vol_z20": float(volz) if pd.notna(volz) else None,
            "mom5": float(mom5) if pd.notna(mom5) else None,
            "volatility10": float(vol10) if pd.notna(vol10) else None,
            "avg_trd_val20": avg_trd_val20,
            "liquidity_pass": liquidity_pass,
            "score": round(score, 2),
            "signals": signals,
            "df": df,  # ìµœì‹ ì´ ì•„ë˜ì¸ ì‹œê³„ì—´
        }
        return result

############################################
#                Plotting                  #
############################################

def plot_stock_chart(df: pd.DataFrame, stock_name: str):
    df = df.copy()
    fig = make_subplots(
        rows=2, cols=1, shared_xaxes=True, vertical_spacing=0.03,
        subplot_titles=(f"{stock_name} ì£¼ê°€", "ê±°ë˜ëŸ‰"), row_heights=[0.7, 0.3]
    )

    fig.add_trace(
        go.Candlestick(
            x=df["stck_bsop_date"],
            open=df["stck_oprc"], high=df["stck_hgpr"], low=df["stck_lwpr"], close=df["stck_clpr"],
            name="ì£¼ê°€",
        ),
        row=1, col=1,
    )

    fig.add_trace(
        go.Scatter(x=df["stck_bsop_date"], y=df["ma5"], name="MA5", line=dict(width=1)),
        row=1, col=1,
    )
    fig.add_trace(
        go.Scatter(x=df["stck_bsop_date"], y=df["ma20"], name="MA20", line=dict(width=1)),
        row=1, col=1,
    )

    colors = [
        "red" if (c - o) >= 0 else "blue"
        for c, o in zip(df["stck_clpr"], df["stck_oprc"])
    ]
    fig.add_trace(
        go.Bar(x=df["stck_bsop_date"], y=df["acml_vol"], name="ê±°ë˜ëŸ‰", marker_color=colors),
        row=2, col=1,
    )

    fig.update_layout(height=600, xaxis_rangeslider_visible=False, showlegend=True, hovermode="x unified")
    return fig

############################################
#                Streamlit                 #
############################################

def main():
    st.set_page_config(page_title="ì½”ìŠ¤í”¼200 ì¢…ëª© ë¶„ì„ ë´‡ (ê°œì„ íŒ)", layout="wide")
    st.title("ğŸ“ˆ ì½”ìŠ¤í”¼200 ì¢…ëª© ë¶„ì„ & ì¶”ì²œ â€” ëª¨ë©˜í…€/ìœ ë™ì„±/ë³€ë™ì„± ìŠ¤ì½”ì–´")
    st.markdown("---")

    # Sidebar
    with st.sidebar:
        st.header("âš™ï¸ API ì„¤ì •")
        app_key = st.text_input("APP KEY", type="password")
        app_secret = st.text_input("APP SECRET", type="password")
        acc_no = st.text_input("ê³„ì¢Œë²ˆí˜¸", value="")

        st.markdown("---")
        st.header("ğŸ“Š ë¶„ì„ ì˜µì…˜")
        top_n = st.slider("ì¶”ì²œ ì¢…ëª© ê°œìˆ˜", 3, 10, 5)
        min_trd_val_krw = st.number_input(
            "ìœ ë™ì„± í•˜í•œ (20D í‰ê·  ê±°ë˜ëŒ€ê¸ˆ, ì›)",
            min_value=0, step=1_000_000_000, value=10_000_000_000,
            help="20ê±°ë˜ì¼ í‰ê· (ì¢…ê°€Ã—ê±°ë˜ëŸ‰)ì´ ê¸°ì¤€ ë¯¸ë§Œì´ë©´ í›„ë³´ì—ì„œ ì œì™¸"
        )
        analyze_btn = st.button("ğŸ” ë¶„ì„ ì‹œì‘", type="primary", use_container_width=True)

    if not analyze_btn:
        st.info("ğŸ‘ˆ ì™¼ìª½ ì‚¬ì´ë“œë°”ì—ì„œ API ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  'ë¶„ì„ ì‹œì‘'ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.")
        st.markdown(
            """
            ### ì´ë²ˆ ë²„ì „ì˜ ìŠ¤ì½”ì–´ êµ¬ì„±
            - **íŠ¸ë Œë“œ(5>20MA)**: +4
            - **5D ëª¨ë©˜í…€**: +2 ~ +3 (ê°•ë„ì— ë”°ë¼) / ì•½ì„¸ ì‹œ -1
            - **ê±°ë˜ëŸ‰ Z-Score(20D)**: +1 ~ +2
            - **RSI(14)**: 45~65 êµ¬ê°„ +1.5 / ê³¼ë§¤ë„ +0.5 / ê³¼ì—´ -0.5
            - **ë³€ë™ì„± í˜ë„í‹°(10D Ïƒ)**: -0.5 ~ -1.0
            - **ì „ì¼ ëŒ€ë¹„ ìƒìŠ¹**: +1

            **ìœ ë™ì„± í•„í„°**: 20D í‰ê·  ê±°ë˜ëŒ€ê¸ˆì´ í•˜í•œ ë¯¸ë§Œì´ë©´ ì œì™¸
            """
        )
        return

    # Validation
    if not app_key or not app_secret:
        st.error("API KEYë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!")
        return

    bot = KISStockBot(app_key, app_secret, acc_no)

    with st.spinner("ì ‘ê·¼ í† í° ë°œê¸‰ ì¤‘..."):
        try:
            bot.get_access_token()
            st.success("âœ… í† í° ë°œê¸‰ ì™„ë£Œ!")
        except Exception as e:
            st.error(str(e))
            return

    stock_dict = bot.get_kospi200_list()

    st.subheader("ğŸ“Š ì¢…ëª© ë¶„ì„ ì¤‘...")
    progress_bar = st.progress(0)
    status_text = st.empty()

    results = []
    total = len(stock_dict)

    for idx, (code, name) in enumerate(stock_dict.items()):
        status_text.text(f"ë¶„ì„ ì¤‘: {name} ({code}) - {idx+1}/{total}")
        try:
            r = bot.analyze_stock(code, name, min_trd_val=min_trd_val_krw)
            if r and r.get("liquidity_pass", False):
                results.append(r)
        except Exception as e:
            st.warning(f"âš ï¸ {name} ë¶„ì„ ì‹¤íŒ¨: {e}")
        time.sleep(0.05)
        progress_bar.progress((idx + 1) / total)

    status_text.empty(); progress_bar.empty()

    if not results:
        st.error("ìœ ë™ì„± ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ ë™ì„± í•˜í•œì„ ë‚®ì¶°ë³´ì„¸ìš”.")
        return

    # ì ìˆ˜ ì •ë ¬
    results.sort(key=lambda x: x["score"], reverse=True)

    st.markdown("---")
    st.subheader(f"ğŸ¯ ë§¤ìˆ˜ ì¶”ì²œ ì¢…ëª© TOP {min(top_n, len(results))}")

    cols = st.columns(min(3, max(1, min(top_n, len(results)))))
    for i, stock in enumerate(results[:top_n]):
        col = cols[i % len(cols)]
        with col:
            st.markdown(f"### {i+1}. {stock['name']}")
            st.metric("í˜„ì¬ê°€", f"{stock['price']:,}ì›")
            st.metric("ì ìˆ˜", f"{stock['score']}")
            st.caption(
                f"ìœ ë™ì„±(20D í‰ê·  ê±°ë˜ëŒ€ê¸ˆ): {int(stock['avg_trd_val20']):,}ì› | 5D ëª¨ë©˜í…€: {stock['mom5']*100 if stock['mom5'] is not None else 0:.1f}% | ë³€ë™ì„±(10D Ïƒ): {(stock['volatility10']*100 if stock['volatility10'] is not None else 0):.2f}%"
            )
            if stock["signals"]:
                st.write("**ë§¤ìˆ˜ ì‹ í˜¸**")
                for s in stock["signals"]:
                    st.markdown(f"- ğŸ”¹ {s}")

    # ì „ì²´ ê²°ê³¼ í…Œì´ë¸”
    st.markdown("---")
    st.subheader("ğŸ“‹ ì „ì²´ ë¶„ì„ ê²°ê³¼")
    df_results = pd.DataFrame([
        {
            "ìˆœìœ„": i + 1,
            "ì¢…ëª©ëª…": r["name"],
            "ì¢…ëª©ì½”ë“œ": r["code"],
            "í˜„ì¬ê°€": r["price"],
            "ì ìˆ˜": r["score"],
            "5Dëª¨ë©˜í…€(%)": round((r["mom5"] or 0) * 100, 2),
            "RSI": round(r["rsi"], 1) if r["rsi"] is not None else None,
            "10DÏƒ(%)": round((r["volatility10"] or 0) * 100, 2),
            "ê±°ë˜ëŸ‰Z(20D)": round(r["vol_z20"], 2) if r["vol_z20"] is not None else None,
            "MA5": round(r["ma5"], 2) if r["ma5"] is not None else None,
            "MA20": round(r["ma20"], 2) if r["ma20"] is not None else None,
            "20Dí‰ê· ê±°ë˜ëŒ€ê¸ˆ": int(r["avg_trd_val20"]) if r["avg_trd_val20"] is not None else None,
            "ì‹ í˜¸": ", ".join(r["signals"]) if r["signals"] else "",
        }
        for i, r in enumerate(results)
    ])

    st.dataframe(
        df_results.assign(í˜„ì¬ê°€=df_results["í˜„ì¬ê°€"].map(lambda x: f"{x:,}ì›")),
        use_container_width=True,
        hide_index=True,
    )

    # ìƒì„¸ ì°¨íŠ¸
    st.markdown("---")
    st.subheader("ğŸ“ˆ ìƒì„¸ ì°¨íŠ¸")
    options = [f"{r['name']} ({r['code']})" for r in results[:top_n]]
    selected = st.selectbox("ì¢…ëª© ì„ íƒ", options=options)
    if selected:
        code = selected.split("(")[-1].split(")")[0]
        r = next((x for x in results if x["code"] == code), None)
        if r is not None:
            c1, c2, c3, c4 = st.columns(4)
            with c1: st.metric("í˜„ì¬ê°€", f"{r['price']:,}ì›")
            with c2: st.metric("MA5", f"{r['ma5']:.0f}" if r["ma5"] else "-")
            with c3: st.metric("MA20", f"{r['ma20']:.0f}" if r["ma20"] else "-")
            with c4: st.metric("RSI", f"{r['rsi']:.1f}" if r["rsi"] else "-")
            fig = plot_stock_chart(r["df"], r["name"])
            st.plotly_chart(fig, use_container_width=True)
            st.info(f"**ë§¤ìˆ˜ ì‹ í˜¸**: {', '.join(r['signals']) if r['signals'] else 'ì—†ìŒ'}")


if __name__ == "__main__":
    main()
